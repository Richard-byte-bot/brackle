<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Brackle</title>
  <style>
    :root{
      --cols: 10;
      --cell: 46px;
      --gap: 8px;
      --radius: 10px;
      --border: #d3d6da;
      --text: #111;
      --muted: #666;
      --bg: #ffffff;

      /* ‚úÖ Wordle-like palette */
      --green: #6aaa64;
      --green-dark: #538d4e;
      --green-soft: #a7caa4;
      --yellow: #c9b458;
      --yellow-dark: #b59f3b;
      --gray: #787c7e;
      --gray-dark: #565758;
      --gray-light: #d3d6da;
    }

    *{ box-sizing: border-box; }

    /* ‚úÖ iOS: reduce double-tap-to-zoom (keeps pinch zoom) */
    html, body{ touch-action: manipulation; }
    button, .cell, .board, .kbdRow1, .bar{ touch-action: manipulation; }
    button, .cell{ -webkit-tap-highlight-color: transparent; }

    body{
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: #fafafa;
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans SC", Arial, sans-serif;
      padding: 22px;
    }

    .app{
      width: min(680px, 100%);
      display: grid;
      gap: 14px;
      justify-items: center;
    }
    .app:focus { outline: none; }

    .top{
      width: 100%;
      display: grid;
      gap: 8px;
      justify-items: center;
      text-align: center;
    }

    .titlebar{
      width: 100%;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    h1{
      margin: 0;
      font-size: 18px;
      font-weight: 750;
      letter-spacing: .2px;
    }

    .iconBtn{
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      border: 0;
      border-radius: 12px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    .legend{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      color: var(--muted);
      font-size: 12.5px;
      margin-top: 2px;
    }
    .dot{
      width: 12px;
      height: 12px;
      border-radius: 4px;
      display: inline-block;
      vertical-align: -2px;
      border: 1px solid rgba(0,0,0,.12);
      margin-right: 6px;
    }
    .dot.g{ background: var(--green); }
    .dot.y{ background: var(--yellow); }
    .dot.x{ background: var(--gray); }

    .bar{
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: nowrap;
      margin-top: -4px;
    }

    button{
      appearance: none;
      border: 0;
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 14px;
      background: #111;
      color: #fff;
      cursor: pointer;
    }
    button:disabled{
      opacity: .45;
      cursor: not-allowed;
    }
    .ghost{
      background: #efefef;
      color: #111;
    }

    .msg{
      width: 100%;
      min-height: 22px;
      text-align: center;
      font-size: 13px;
      color: #b00020;
      margin-top: 20px;
    }
    .msg.ok{ color: var(--green-dark); }

    .statusbar{
      width: 100%;
      display: grid;
      justify-content: center;
    }
    .pill{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: #fff;
      color: #222;
      font-size: 13px;
      box-shadow: 0 1px 0 rgba(0,0,0,.05);
    }
    .pill .k{ color: var(--muted); }
    .pill .v{ font-weight: 650; }
    .pill.dim{ opacity: .55; }

    /* ‚úÖ Ê£ãÁõòÔºöÊ≠£Â∏∏Â±Ö‰∏≠ÊíëÊª°ËßÜËßâÔºõÊûÅÁ™ÑÊâçÊªöÂä®ÔºàÊªöÂä®Êó∂Â∑¶ÂØπÈΩêÔºâ */
    .board{
      width: 100%;
      max-width: 100%;
      user-select: none;

      display: flex;
      flex-direction: column;
      gap: 10px;

      align-items: center;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-gutter: stable both-edges;
    }
    .board.scrolling{
      align-items: flex-start;
    }

    .row{
      display: grid;
      grid-template-columns: repeat(var(--cols), var(--cell));
      gap: var(--gap);
      width: max-content;
    }

    .cell{
      width: var(--cell);
      height: var(--cell);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg);
      display: grid;
      place-items: center;
      font-size: 22px;
      font-weight: 800;
      line-height: 1;
    }

    .cell.cursor{
      border-color: #7a7a7a;
      box-shadow: 0 0 0 3px rgba(0,0,0,.06);
    }

    .cell.g{ background: var(--green); border-color: var(--green-dark); color:#fff; }
    .cell.y{ background: var(--yellow); border-color: var(--yellow-dark); color:#fff; }
    .cell.x{ background: var(--gray); border-color: var(--gray-dark); color:#fff; }

    .cell.clickable{ cursor: pointer; }
    .cell.clickable:hover{ border-color: #9a9a9a; }

    .row.future .cell{
      background: #f3f3f3;
      border-color: var(--gray-light);
      color: rgba(0,0,0,.18);
    }

    .spacer{ height: 14px; }

    .tools{
      width: 100%;
      display: grid;
      gap: 10px;
      justify-items: center;
      user-select: none;
    }

    .kbdRow1{
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .kbdRow1 button{
      background: #efefef;
      color: #111;
      border-radius: 14px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 400;
      box-shadow: 0 1px 0 rgba(0,0,0,.06);
    }

    .kbdRow1 button:active{
      transform: translateY(1px);
    }

    /* ‚úÖ Modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: grid;
      place-items: center;
      padding: 18px;
      z-index: 999;

      /* ‚úÖ Â±èÂπï‰∏çÂ§üÈ´òÊó∂ÔºåÂÖÅËÆ∏Êï¥‰ΩìÊªöÂä® */
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal.hidden{ display: none; }

    .modalCard{
      width: min(520px, 100%);
      background: #fff;
      border-radius: 18px;
      padding: 18px 18px 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);

      /* ‚úÖ Â±èÂπï‰∏çÂ§üÈ´òÊó∂ÔºåÂç°ÁâáÂÜÖÈÉ®ÂèØÊªöÂä® */
      max-height: calc(100vh - 36px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    .modalTop{
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin-bottom: 12px;
    }
    .modalTitle{
      font-weight: 800;
      letter-spacing: .5px;
      font-size: 18px;
    }
    .closeBtn{
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: transparent;
      color: #111;
      font-size: 22px;
      line-height: 1;
      padding: 0;
    }
    .closeBtn:hover{ background: #f1f1f1; }
    /* ‚úÖ Á¶ÅÁî®ÊµèËßàÂô®ÈªòËÆ§ËìùÊ°Ü */
    .closeBtn:focus,
    .closeBtn:focus-visible{
      outline: none !important;
      box-shadow: none !important;
    }

    .statsGrid{
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      text-align: center;
      margin: 8px 0 14px;
    }
    .statNum{
      font-size: 28px;
      font-weight: 850;
      line-height: 1.1;
    }
    .statLbl{
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .distTitle{
      font-weight: 800;
      font-size: 14px;
      text-align: center;
      margin: 8px 0 10px;
      letter-spacing: .4px;
    }

    .dist{
      display: grid;
      gap: 8px;
    }
    .distRow{
      display: grid;
      grid-template-columns: 18px 1fr;
      gap: 10px;
      align-items: center;
    }
    .distKey{
      text-align: right;
      font-weight: 700;
      color: #333;
    }
    .distBar{
      height: 26px;
      border-radius: 6px;
      background: transparent;
      display: flex;
      align-items: center;
    }
    .distFill{
      height: 26px;
      border-radius: 6px;
      background: var(--gray);
      display: inline-flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 10px;
      min-width: 34px;
      color: #fff;
      font-weight: 800;
    }
    .distFill.zero{
      background: var(--gray);
      color: #fff;
      opacity: .9;
      /* ‚úÖ Êï∞Â≠ó‰ΩçÁΩÆÂíåÂÖ∂‰ªñË°å‰∏ÄËá¥ */
      justify-content: flex-end;
    }
    .distFill.todayWin{ background: var(--green); }
    .distFill.todayLose{ background: var(--gray-dark); }

    .modalBottom{
      display: grid;
      grid-template-columns: 1fr 1px 1fr; /* ‚úÖ ÈªòËÆ§ÔºöNEXT Â∑¶„ÄÅSHARE Âè≥ */
      gap: 16px;
      align-items: center;
      margin-top: 16px;
    }
    .divider{
      width: 1px;
      height: 44px;
      background: rgba(0,0,0,.12);
      justify-self: center;
    }

    .nextBox .nextLbl{
      font-weight: 800;
      font-size: 14px;
      letter-spacing: .4px;
      color: #111;
      font-size: 12px;
    }
    .nextBox .nextTime{
      font-size: 34px;
      font-weight: 900;
      letter-spacing: .5px;
      margin-top: 4px;
    }

    .shareBtn{
      background: var(--green);
      font-size: 14px;
      color: #fff;
      border-radius: 14px;
      height: 46px;
      font-weight: 850;
      letter-spacing: .4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0; /* ‚úÖ ‰∏çË¶ÅÂè≥ËæπÂ∞èÂõæÊ†á‰∫Ü */
      width: 100%;
      white-space: nowrap; /* ‚úÖ ËÉΩÊîæ‰∏ãÂ∞±Âà´Êç¢Ë°å */
    }
    .shareBtn:disabled{
      background: var(--green-soft);
      opacity: 1;
    }

    @media (max-width: 520px){
      body{
        padding-top: 10px;
        padding-bottom: 10px;
        padding-left: calc(10px + env(safe-area-inset-left));
        padding-right: calc(10px + env(safe-area-inset-right));
      }

      :root{ --cell: 36px; --gap: 6px; }

      .cell{
        font-size: clamp(16px, 4.6vw, 22px);
      }

      .kbdRow1{
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
      }
      .kbdRow1 button{
        width: 100%;
        min-width: 0;
        height: 44px;
        font-size: 15px;
        padding: 0 14px;
        border-radius: 14px;
        line-height: 1;
      }

      .bar button{
        flex: 1;
        min-width: 0;
        width: auto;
        height: 46px;
        font-size: 15px;
        border-radius: 14px;
        box-shadow: 0 1px 0 rgba(0,0,0,.06);
      }

      .statsGrid{
        grid-template-columns: repeat(2, 1fr);
      }
      /* ‚úÖ Ê≥®ÊÑèÔºöËøôÈáå‰∏çÂÜçÂº∫Âà∂ modalBottom ÂèòÂçïÂàóÔºàÂ§ßÂ§öÊï∞Áé∞‰ª£ÊâãÊú∫‰ªçËÉΩÂ∑¶Âè≥Âπ∂ÊéíÔºâ */
      .nextBox .nextTime{ font-size: 32px; }
    }

    /* ‚úÖ Âè™ÊúâÊûÅÁ´ØÁ™ÑÊâçÊç¢Ë°å + NEXT Â±Ö‰∏≠ */
    @media (max-width: 360px){
      .modalBottom{
        grid-template-columns: 1fr;
      }
      .divider{ display: none; }
      .nextBox{ text-align: center; }
      .shareBtn{ width: 100%; }
    }
  

  /* ‚úÖ Confetti */
    #confetti{
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 2000;
      display: none;
    }
    .confetti-piece{
      position: absolute;
      top: -16px;
      width: 10px;
      height: 16px;
      border-radius: 2px;
      opacity: .95;
      will-change: transform;
      animation-name: confetti-fall;
      animation-timing-function: linear;
      animation-fill-mode: forwards;
    }
    @keyframes confetti-fall{
      from{ transform: translate3d(0,0,0) rotate(0deg); }
      to{ transform: translate3d(var(--dx, 0px), 110vh, 0) rotate(var(--rot, 720deg)); }
    }
</style>
</head>

<body>
  <main class="app" id="app" tabindex="0" aria-label="Brackle">
    <header class="top">
      <div class="titlebar">
        <h1>BRACKLE</h1>
        <button id="openStats" class="iconBtn ghost" type="button" title="Stats" aria-label="Stats">Stats</button>
      </div>
      <div class="legend" aria-label="Legend">
        <span><i class="dot g"></i>Hit</span>
        <span><i class="dot y"></i>Off by 1‚Äì2</span>
        <span><i class="dot x"></i>Off by ‚â•3</span>
      </div>
    </header>

    <div class="statusbar" aria-label="Status">
      <div id="matchPill" class="pill dim">
        <span class="k">Hits</span>
        <span class="v" id="matchCount">‚Äî</span>
        <span class="k">/</span>
        <span class="v" id="matchTotal">10</span>
      </div>
    </div>

    <div id="msg" class="msg" role="status" aria-live="polite"></div>

    <section id="board" class="board" aria-label="Board"></section>

    <div class="spacer" aria-hidden="true"></div>

    <div class="tools" aria-label="Keyboard">
      <div class="kbdRow1" aria-label="Bracket keyboard">
        <button id="keyL" type="button">(</button>
        <button id="keyR" type="button">)</button>
        <button id="keyBk" type="button">Backspace</button>
      </div>
    </div>

    <!-- ‚úÖ È´òÂ∫¶ËßÜÂõæ + Êèê‰∫§ÔºöÂêå‰∏ÄË°å -->
    <div class="bar">
      <button id="toggleView" type="button" class="ghost" title="Shortcut: B">Height View</button>
      <button id="submit">Submit</button>
    </div>
  </main>

  <!-- ‚úÖ Statistics Modal -->
  <div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Statistics">
    <div class="modalCard" id="modalCard">
      <div class="modalTop">
        <div class="modalTitle">STATISTICS</div>
        <button id="closeModal" class="closeBtn" type="button" aria-label="Close">√ó</button>
      </div>

      <div class="statsGrid" aria-label="ÁªüËÆ°Êï∞Â≠ó">
        <div>
          <div class="statNum" id="sPlayed">0</div>
          <div class="statLbl">Played</div>
        </div>
        <div>
          <div class="statNum" id="sWinPct">0</div>
          <div class="statLbl">Win %</div>
        </div>
        <div>
          <div class="statNum" id="sCurStreak">0</div>
          <div class="statLbl">Current Streak</div>
        </div>
        <div>
          <div class="statNum" id="sMaxStreak">0</div>
          <div class="statLbl">Max Streak</div>
        </div>
      </div>

      <div class="distTitle">GUESS DISTRIBUTION</div>
      <div class="dist" id="dist"></div>

      <div class="modalBottom">
        <div class="nextBox">
          <div class="nextLbl">NEXT BRACKLE</div>
          <div class="nextTime" id="countdown">00:00:00</div>
        </div>
        <div class="divider"></div>
        <button id="shareBtn" class="shareBtn" type="button">SHARE</button>
      </div>
    </div>
  </div>

  <div id="confetti" aria-hidden="true"></div>

<script>
(() => {
  const VERSION = 1;
  const N = 5;
  const L = 2 * N;        // 10
  const MAX_TRIES = 6;

  // ‚úÖ End-game modal timing (ms)
  const END_MODAL_DELAY_WIN = 2100;   // confetti first
  const END_MODAL_DELAY_LOSE = 1800;  // avoid jumpscare
  const END_MODAL_DELAY_LOAD = 650;   // refresh/reopen

  const LS_STATS_KEY = `brackle_stats_v${VERSION}`;
  const LS_DAY_PREFIX = `brackle_day_v${VERSION}_`;

  const $app = document.getElementById('app');
  const $submit = document.getElementById('submit');
  const $toggleView = document.getElementById('toggleView');
  const $msg = document.getElementById('msg');
  const $board = document.getElementById('board');

  const $keyL = document.getElementById('keyL');
  const $keyR = document.getElementById('keyR');
  const $keyBk = document.getElementById('keyBk');

  const $matchPill = document.getElementById('matchPill');
  const $matchCount = document.getElementById('matchCount');
  const $matchTotal = document.getElementById('matchTotal');
  $matchTotal.textContent = String(L);
  document.documentElement.style.setProperty('--cols', String(L));

  // modal
  const $modal = document.getElementById('modal');
  const $modalCard = document.getElementById('modalCard');
  const $closeModal = document.getElementById('closeModal');
  const $openStats = document.getElementById('openStats');
  const $shareBtn = document.getElementById('shareBtn');
  const $countdown = document.getElementById('countdown');
  const $dist = document.getElementById('dist');

  const $sPlayed = document.getElementById('sPlayed');
  const $sWinPct = document.getElementById('sWinPct');
  const $sCurStreak = document.getElementById('sCurStreak');
  const $sMaxStreak = document.getElementById('sMaxStreak');

  // ‚úÖ iOS Safari fallback: prevent double-tap zoom (keeps pinch-zoom)
  (function preventDoubleTapZoom(){
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e) => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, { passive: false });
    document.addEventListener('dblclick', (e) => e.preventDefault());
  })();

  function safeLSGet(key) {
    try { return localStorage.getItem(key); } catch { return null; }
  }
  function safeLSSet(key, val) {
    try { localStorage.setItem(key, val); } catch {}
  }

  function pad2(n){ return String(n).padStart(2,'0'); }

  function todayKeyUTC() {
    const d = new Date();
    const y = d.getUTCFullYear();
    const m = d.getUTCMonth() + 1;
    const dd = d.getUTCDate();
    return `${y}-${pad2(m)}-${pad2(dd)}`;
  }

  function dateAddDaysUTC(yyyy_mm_dd, delta) {
    const [y,m,dd] = yyyy_mm_dd.split('-').map(Number);
    const dt = new Date(Date.UTC(y, m-1, dd));
    dt.setUTCDate(dt.getUTCDate() + delta);
    return `${dt.getUTCFullYear()}-${pad2(dt.getUTCMonth()+1)}-${pad2(dt.getUTCDate())}`;
  }

  function dateAddDays(yyyy_mm_dd, delta) {
    const [y,m,dd] = yyyy_mm_dd.split('-').map(Number);
    const dt = new Date(y, m-1, dd);
    dt.setDate(dt.getDate() + delta);
    return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
  }

  function nextMidnightMsUTC() {
    const now = new Date();
    const nxt = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1, 0,0,0,0);
    return nxt;
  }

  function formatHHMMSS(ms) {
    if (ms <= 0) return '00:00:00';
    const total = Math.floor(ms / 1000);
    const h = Math.floor(total / 3600);
    const m = Math.floor((total % 3600) / 60);
    const s = total % 60;
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  }

  function allDyckWords(n) {
    const res = [];
    function dfs(s, open, close) {
      if (s.length === 2*n) { res.push(s); return; }
      if (open < n) dfs(s + '(', open + 1, close);
      if (close < open) dfs(s + ')', open, close + 1);
    }
    dfs('', 0, 0);
    return res;
  }
  // ‚úÖ ÊéíÈô§Ëøá‰∫é‚ÄúÈªòËÆ§È¶ñÁåú‚ÄùÁöÑÁ≠îÊ°à
  const EXCLUDE_ANSWERS = new Set(['()()()()()']);
  const DICT = allDyckWords(N).filter(w => !EXCLUDE_ANSWERS.has(w));

  function hash32(str){
    let h = 0x811c9dc5;
    for (let i = 0; i < str.length; i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 0x01000193);
    }
    return (h >>> 0);
  }

  function dailyAnswer(dateStr){
    const idx = hash32('BRACKLE|' + dateStr) % DICT.length;
    return DICT[idx];
  }

  function balances(s) {
    const b = [];
    let bal = 0;
    for (let i = 0; i < s.length; i++) {
      bal += (s[i] === '(') ? 1 : -1;
      b.push(bal);
    }
    return b;
  }

  function isValidDyck(s) {
    if (s.length !== L) return { ok: false, why: `Length must be ${L}.` };
    if (!/^[()]+$/.test(s)) return { ok: false, why: 'Only ( and ) are allowed.' };
    let bal = 0;
    for (let i = 0; i < s.length; i++) {
      bal += (s[i] === '(') ? 1 : -1;
      if (bal < 0) return { ok: false, why: `Check the prefix height at position ${i+1}.` };
      if (bal > N) return { ok: false, why: `ËØ∑Ê£ÄÊü•Á¨¨ ${i+1} ‰ΩçÁöÑÂâçÁºÄÈ´òÂ∫¶„ÄÇ` };
    }
    if (bal !== 0) return { ok: false, why: 'Total number of ( and ) must match.' };
    return { ok: true, why: '' };
  }

  function colorClassForDiff(diff) {
    if (diff === 0) return 'g';
    if (diff <= 2) return 'y';
    return 'x';
  }
  function labelForClass(cls) {
    if (cls === 'g') return 'Hit';
    if (cls === 'y') return 'Off by 1‚Äì2';
    return 'Off by ‚â•3';
  }

  function countMatches(gBal, ansBal) {
    let c = 0;
    for (let i = 0; i < L; i++) if (gBal[i] === ansBal[i]) c++;
    return c;
  }

  function setMsg(text, ok=false) {
    $msg.textContent = text || '';
    $msg.className = ok ? 'msg ok' : 'msg';
  }

  function setMatchPill(valueOrNull) {
    if (valueOrNull === null) {
      $matchCount.textContent = '‚Äî';
      $matchPill.classList.add('dim');
      return;
    }
    $matchCount.textContent = String(valueOrNull);
    $matchPill.classList.remove('dim');
  }

  function focusGame() {
    if (modalOpen) return;
    $app.focus({ preventScroll: true });
  }

  // ‚úÖ Ëá™ÈÄÇÂ∫îÔºö‰∏çÂè™ÊâãÊú∫Á´ØÔºå‰ªª‰ΩïÂÆΩÂ∫¶‰∏çÂ§üÈÉΩÁº©Ê†ºÂ≠êÔºàÊûÅÁ™ÑÊâçÊªöÂä®Ôºâ
  function fitCellsToBoard() {
    const boardW = $board.clientWidth || 0;
    if (boardW <= 0) return;

    const usable = Math.max(0, boardW - 2);

    const DEFAULT_CELL = 46;
    const DEFAULT_GAP = 8;
    const requiredDefault = L * DEFAULT_CELL + (L - 1) * DEFAULT_GAP;

    // Â§üÂÆΩÔºö‰øùÊåÅÂéüÊ†∑
    if (requiredDefault <= usable) {
      document.documentElement.style.setProperty('--cell', DEFAULT_CELL + 'px');
      document.documentElement.style.setProperty('--gap', DEFAULT_GAP + 'px');
      return;
    }

    // ‰∏çÂ§üÔºöÊåâÊØî‰æãÁÆóÂà∞‚ÄúÂàöÂ•ΩÊíëÊª°‚Äù
    const MIN_CELL = 26;   // ÂÜçÁ™ÑÂ∞±ËÆ©ÂÆÉÊªöÂä®ÔºàÂõ†‰∏∫ËøôÈáå‰∏çÂÜçÁªßÁª≠Áº©Ôºâ
    const MAX_CELL = 44;

    const ratio = 0.07;
    let cell = usable / (L + (L - 1) * ratio);
    cell = Math.min(MAX_CELL, cell);

    let gap = cell * ratio;
    gap = Math.max(2.0, Math.min(7.0, gap));

    cell = (usable - (L - 1) * gap) / L;

    if (cell < MIN_CELL) {
      cell = MIN_CELL; // ‚úÖ ÊûÅÁ´ØÁ™ÑÔºöÂõ∫ÂÆöÊúÄÂ∞èÊ†ºÂ≠êÔºåÊ®™ÂêëÊªöÂä®Êù°Â∞±‰ºöÂá∫Áé∞
      // gap Áî®‰∏Ä‰∏™ÂÅèÂ∞è‰ΩÜ‰∏çÊå§ÁöÑÂÄº
      gap = Math.max(2.0, Math.min(6.0, gap));
    }

    const cellPx = Math.round(cell * 10) / 10;
    const gapPx = Math.round(gap * 10) / 10;

    document.documentElement.style.setProperty('--cell', cellPx + 'px');
    document.documentElement.style.setProperty('--gap', gapPx + 'px');
  }

  function updateBoardAlign() {
    const row = $board.querySelector('.row');
    if (!row) return;
    const needScroll = row.scrollWidth > $board.clientWidth + 1;
    $board.classList.toggle('scrolling', needScroll);
  }

  // ‚úÖ Global stats
  function defaultStats() {
    return {
      played: 0,
      wins: 0,
      currentStreak: 0,
      maxStreak: 0,
      lastPlayedDate: null,
      lastResultWasWin: false,
      dist: { "1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"X":0 }
    };
  }

  function loadStats() {
    const raw = safeLSGet(LS_STATS_KEY);
    if (!raw) return defaultStats();
    try {
      const s = JSON.parse(raw);
      if (!s || typeof s !== 'object') return defaultStats();
      if (!s.dist) s.dist = { "1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"X":0 };
      for (const k of ["1","2","3","4","5","6","X"]) if (typeof s.dist[k] !== 'number') s.dist[k] = 0;
      for (const k of ["played","wins","currentStreak","maxStreak"]) if (typeof s[k] !== 'number') s[k] = 0;
      if (typeof s.lastPlayedDate !== 'string') s.lastPlayedDate = null;
      if (typeof s.lastResultWasWin !== 'boolean') s.lastResultWasWin = false;
      return s;
    } catch {
      return defaultStats();
    }
  }

  function saveStats(stats) {
    safeLSSet(LS_STATS_KEY, JSON.stringify(stats));
  }

  // ‚úÖ Day state
  function dayStorageKey(dateStr){ return LS_DAY_PREFIX + dateStr; }

  function defaultDayState(dateStr) {
    return {
      date: dateStr,
      rounds: [],
      activeGuess: '',
      awaitingReveal: false,
      done: false,
      won: false,
      tries: 0,
      showBalance: false,
      matchValue: null,
      recorded: false
    };
  }

  function loadDayState(dateStr) {
    const raw = safeLSGet(dayStorageKey(dateStr));
    if (!raw) return defaultDayState(dateStr);
    try {
      const st = JSON.parse(raw);
      if (!st || st.date !== dateStr) return defaultDayState(dateStr);

      if (!Array.isArray(st.rounds)) st.rounds = [];
      if (typeof st.activeGuess !== 'string') st.activeGuess = '';
      if (typeof st.awaitingReveal !== 'boolean') st.awaitingReveal = false;
      if (typeof st.done !== 'boolean') st.done = false;
      if (typeof st.won !== 'boolean') st.won = false;
      if (typeof st.tries !== 'number') st.tries = st.rounds.length;
      if (typeof st.showBalance !== 'boolean') st.showBalance = false;
      if (!(typeof st.matchValue === 'number' || st.matchValue === null)) st.matchValue = null;
      if (typeof st.recorded !== 'boolean') st.recorded = false;

      st.rounds = st.rounds.slice(0, MAX_TRIES).map(r => {
        const guess = (r && typeof r.guess === 'string') ? r.guess.slice(0, L) : '';
        const gBal = Array.isArray(r && r.gBal) ? r.gBal.slice(0, L).map(x => Number(x)) : (guess.length === L ? balances(guess) : Array(L).fill(0));
        const revealed = Array.isArray(r && r.revealed) ? r.revealed.slice(0, L).map(x => (x === 'g' || x === 'y' || x === 'x') ? x : null) : Array(L).fill(null);
        return { guess, gBal, revealed };
      });

      st.tries = st.rounds.length;
      return st;
    } catch {
      return defaultDayState(dateStr);
    }
  }

  function saveDayState() {
    const st = {
      date: today,
      rounds,
      activeGuess,
      awaitingReveal,
      done,
      won,
      tries,
      showBalance,
      matchValue,
      recorded
    };
    safeLSSet(dayStorageKey(today), JSON.stringify(st));
  }

  // ‚úÖ Modal control
  let modalOpen = false;

  function openModal() {
    modalOpen = true;
    $modal.classList.remove('hidden');
    $shareBtn.disabled = !done;
    focusModal();
  }

  function closeModal() {
    modalOpen = false;
    $modal.classList.add('hidden');
    focusGame();
    render();
  }

  function focusModal() {
    $closeModal.focus({ preventScroll: true });
  }

  function renderStatsModal() {
    const stats = loadStats();

    const played = stats.played || 0;
    const wins = stats.wins || 0;
    const winPct = played === 0 ? 0 : Math.round((wins / played) * 100);

    $sPlayed.textContent = String(played);
    $sWinPct.textContent = String(winPct);
    $sCurStreak.textContent = String(stats.currentStreak || 0);
    $sMaxStreak.textContent = String(stats.maxStreak || 0);

    let todayKeyBar = null;
    let todayBarClass = null;
    if (done) {
      if (won) { todayKeyBar = String(tries); todayBarClass = 'todayWin'; }
      else { todayKeyBar = 'X'; todayBarClass = 'todayLose'; }
    }

    const dist = stats.dist || { "1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"X":0 };
    const keys = ["1","2","3","4","5","6"];
    const showX = (dist["X"] || 0) > 0 || todayKeyBar === 'X';

    const maxVal = Math.max(
      1,
      ...keys.map(k => dist[k] || 0),
      showX ? (dist["X"] || 0) : 0
    );

    $dist.innerHTML = '';

    function addRow(k, count) {
      const row = document.createElement('div');
      row.className = 'distRow';

      const key = document.createElement('div');
      key.className = 'distKey';
      key.textContent = k;

      const bar = document.createElement('div');
      bar.className = 'distBar';

      const fill = document.createElement('div');
      fill.className = 'distFill';

      let pct = (count / maxVal) * 100;
      if (count === 0) {
        // ‚úÖ 0Ôºö‰øùÊåÅ‰∏Ä‰∏™ÂæàÁü≠ÁöÑÂ∞èÊù°ÔºàÊü±ÂΩ¢ÂõæËØ≠‰πâ‰∏çÂèòÔºâÔºåÈ¢úËâ≤‰∏éÂÖ∂‰ªñÁÅ∞Êù°‰∏ÄËá¥
        fill.classList.add('zero');
        pct = 0; // ÈÖçÂêà CSS ÁöÑ min-width ÂΩ¢Êàê‚Äú0 Â∞èÂùó‚Äù
      } else {
        pct = Math.max(10, pct);
      }
      pct = Math.min(100, pct);
      fill.style.width = pct + '%';

      if (todayKeyBar === k) {
        fill.classList.add(todayBarClass);
        fill.classList.remove('zero');
      }

      fill.textContent = String(count);

      bar.appendChild(fill);
      row.appendChild(key);
      row.appendChild(bar);
      $dist.appendChild(row);
    }

    for (const k of keys) addRow(k, dist[k] || 0);
    if (showX) addRow('X', dist['X'] || 0);
  }

  let countdownTimer = null;
  function startCountdown() {
    if (countdownTimer) clearInterval(countdownTimer);
    function tick() {
      const ms = nextMidnightMsUTC() - Date.now();
      $countdown.textContent = formatHHMMSS(ms);
    }
    tick();
    countdownTimer = setInterval(tick, 1000);
  }

  async function copyText(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        ta.style.top = '0';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      } catch {
        return false;
      }
    }
  }

  // ‚úÖ Confetti (win only)
  const $confetti = document.getElementById('confetti');
  function launchConfetti(durationMs = 1800) {
    if (!$confetti) return;
    $confetti.innerHTML = '';
    $confetti.style.display = 'block';

    const colors = [
      getComputedStyle(document.documentElement).getPropertyValue('--green').trim() || '#6aaa64',
      getComputedStyle(document.documentElement).getPropertyValue('--yellow').trim() || '#c9b458',
      getComputedStyle(document.documentElement).getPropertyValue('--gray').trim() || '#787c7e',
      '#b4a7d6', '#66c2a5', '#fc8d62'
    ];

    const W = window.innerWidth;
    const count = Math.min(140, Math.max(90, Math.floor(W / 6)));

    for (let i = 0; i < count; i++) {
      const p = document.createElement('div');
      p.className = 'confetti-piece';

      const left = Math.random() * 100;
      const dx = (Math.random() * 2 - 1) * 140;
      const rot = 540 + Math.random() * 720;
      const dur = 1400 + Math.random() * 900;
      const delay = Math.random() * 200;
      const w = 8 + Math.random() * 6;
      const h = 10 + Math.random() * 10;

      p.style.left = left + 'vw';
      p.style.width = w + 'px';
      p.style.height = h + 'px';
      p.style.background = colors[(Math.random() * colors.length) | 0];
      p.style.setProperty('--dx', dx.toFixed(0) + 'px');
      p.style.setProperty('--rot', rot.toFixed(0) + 'deg');
      p.style.animationDuration = dur.toFixed(0) + 'ms';
      p.style.animationDelay = delay.toFixed(0) + 'ms';

      $confetti.appendChild(p);
    }

    window.setTimeout(() => {
      $confetti.style.display = 'none';
      $confetti.innerHTML = '';
    }, durationMs);
  }

  let endModalScheduled = false;
  function scheduleEndModal(isWin, fromLoad = false) {
    if (endModalScheduled) return;
    endModalScheduled = true;

    const delay = fromLoad ? END_MODAL_DELAY_LOAD : (isWin ? END_MODAL_DELAY_WIN : END_MODAL_DELAY_LOSE);

    if (!fromLoad && isWin) {
      // keep confetti slightly shorter than modal delay
      launchConfetti(Math.max(1200, delay - 250));
    }

    window.setTimeout(() => {
      renderStatsModal();
      openModal();
    }, delay);
  }

  function emojiForDiff(diff){
    if (diff === 0) return 'üü©';
    if (diff <= 2) return 'üü®';
    return '‚¨õ';
  }

  function makeShareText() {
    const dateCompact = today.replace(/-/g, '');
    const result = won ? `${tries}/${MAX_TRIES}` : `X/${MAX_TRIES}`;
    const hits = rounds.map(rr => countMatches(rr.gBal, ansBal)).join(' ‚Üí ');
    const base = `${location.origin}${location.pathname}`.replace(/\/$/, '');

    // ‚úÖ Multi-line (less spoiler-y)
    return `BRACKLE ${dateCompact} ${result}

${hits}
@brackle ${base}`;
  }

  function updateStatsIfNeeded() {
    if (!done) return;
    if (recorded) return;

    const stats = loadStats();
    const resultKey = won ? String(tries) : 'X';

    if (stats.lastPlayedDate === today) {
      recorded = true;
      saveDayState();
      return;
    }

    stats.played += 1;
    if (won) stats.wins += 1;

    if (!stats.dist) stats.dist = { "1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"X":0 };
    if (typeof stats.dist[resultKey] !== 'number') stats.dist[resultKey] = 0;
    stats.dist[resultKey] += 1;

    const yday = dateAddDaysUTC(today, -1);
    if (won) {
      if (stats.lastPlayedDate === yday && stats.lastResultWasWin === true) stats.currentStreak += 1;
      else stats.currentStreak = 1;
      stats.maxStreak = Math.max(stats.maxStreak, stats.currentStreak);
      stats.lastResultWasWin = true;
    } else {
      stats.currentStreak = 0;
      stats.lastResultWasWin = false;
    }

    stats.lastPlayedDate = today;
    saveStats(stats);

    recorded = true;
    saveDayState();
  }

  // ========= Game state (today) =========
  const today = todayKeyUTC();
  const answer = dailyAnswer(today);
  const ansBal = balances(answer);

  let st = loadDayState(today);

  let rounds = st.rounds;
  let activeGuess = st.activeGuess;
  let awaitingReveal = st.awaitingReveal;
  let done = st.done;
  let won = st.won;
  let tries = st.tries;
  let showBalance = st.showBalance;
  let matchValue = st.matchValue;
  let recorded = st.recorded;

  $toggleView.textContent = showBalance ? 'Bracket View' : 'Height View';

  function activeRowBalanceDisplay() {
    const out = Array(L).fill('');
    let bal = 0;
    let invalid = false;

    for (let i = 0; i < activeGuess.length; i++) {
      const ch = activeGuess[i];
      if (!invalid) {
        bal += (ch === '(') ? 1 : -1;
        const remaining = L - (i + 1);
        if (bal < 0 || bal > N || bal > remaining) invalid = true;
      }
      out[i] = invalid ? '-' : String(bal);
    }

    const cursor = activeGuess.length;
    if (cursor < L) out[cursor] = invalid ? '-' : String(bal);

    return out;
  }

  function render() {
    $board.innerHTML = '';

    const activeBalDisp = showBalance ? activeRowBalanceDisplay() : null;

    for (let r = 0; r < MAX_TRIES; r++) {
      const row = document.createElement('div');
      row.className = 'row';

      const isSubmitted = r < rounds.length;
      const isActiveRow = (!done && !awaitingReveal && r === rounds.length);

      const isFutureRow = (!done) && (awaitingReveal ? (r >= rounds.length) : (r > rounds.length));
      if (isFutureRow) row.classList.add('future');

      const guessStr = isSubmitted ? rounds[r].guess : (isActiveRow ? activeGuess : '');

      for (let i = 0; i < L; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';

        if (showBalance) {
          if (isSubmitted) cell.textContent = String(rounds[r].gBal[i]);
          else if (isActiveRow) cell.textContent = activeBalDisp[i] || '';
          else cell.textContent = '';
        } else {
          cell.textContent = guessStr[i] || '';
        }

        if (isActiveRow && i === activeGuess.length && activeGuess.length < L) {
          cell.classList.add('cursor');
        }

        if (isSubmitted) {
          const rr = rounds[r];
          if (done) {
            const diff = Math.abs(rr.gBal[i] - ansBal[i]);
            cell.classList.add(colorClassForDiff(diff));
          } else {
            const cls = rr.revealed[i];
            if (cls) cell.classList.add(cls);
          }
        }

        if (!modalOpen && !done && awaitingReveal && isSubmitted) {
          const rr = rounds[r];
          if (!rr.revealed[i]) {
            cell.classList.add('clickable');
            cell.title = 'Click to reveal this hint';
            cell.addEventListener('click', () => {
              if (modalOpen) return;
              if (!awaitingReveal || done) return;
              if (rr.revealed[i]) return;

              const diff = Math.abs(rr.gBal[i] - ansBal[i]);
              const cls = colorClassForDiff(diff);

              rr.revealed[i] = cls;

              awaitingReveal = false;
              saveDayState();

              setMsg(`Revealed row ${r+1}, col ${i+1}: ${labelForClass(cls)}.`, true);
              render();
              focusGame();
            });
          }
        }

        row.appendChild(cell);
      }

      $board.appendChild(row);
    }

    $submit.disabled = done || awaitingReveal || modalOpen;
    $toggleView.disabled = modalOpen;
    requestAnimationFrame(updateBoardAlign);
  }

  function toggleBalanceView() {
    if (modalOpen) return;
    showBalance = !showBalance;
    $toggleView.textContent = showBalance ? 'Bracket View' : 'Height View';
    saveDayState();
    render();
    focusGame();
  }

  function pushChar(ch) {
    if (modalOpen) return;
    if (done || awaitingReveal) return;
    if (activeGuess.length >= L) return;
    activeGuess += ch;
    setMsg('');
    saveDayState();
    render();
    focusGame();
  }

  function backspace() {
    if (modalOpen) return;
    if (done || awaitingReveal) return;
    if (activeGuess.length === 0) return;
    activeGuess = activeGuess.slice(0, -1);
    setMsg('');
    saveDayState();
    render();
    focusGame();
  }

  function submitGuess() {
    if (modalOpen) return;
    if (done) return;

    if (awaitingReveal) {
      setMsg('Reveal a hint first: click any submitted cell.');
      return;
    }

    if (tries >= MAX_TRIES) return;

    if (activeGuess.length !== L) {
      setMsg('Current row is not full.');
      return;
    }

    const v = isValidDyck(activeGuess);
    if (!v.ok) {
      setMsg(`Invalid input: ${v.why}`);
      return;
    }

    tries++;
    const gBal = balances(activeGuess);
    const rr = { guess: activeGuess, gBal, revealed: Array(L).fill(null) };
    rounds.push(rr);

    const matches = countMatches(gBal, ansBal);
    matchValue = matches;
    setMatchPill(matches);

    if (activeGuess === answer) {
      done = true;
      won = true;
      awaitingReveal = false;
      activeGuess = '';
      matchValue = L;
      setMatchPill(L);
      setMsg(`Solved in ${tries}.`, true);

      saveDayState();
      updateStatsIfNeeded();
      render();

      scheduleEndModal(true);
      return;
    }

    if (tries >= MAX_TRIES) {
      done = true;
      won = false;
      awaitingReveal = false;
      activeGuess = '';
      setMsg(`No more tries. Answer: ${answer}„ÄÇ`);

      saveDayState();
      updateStatsIfNeeded();
      render();

      scheduleEndModal(false);
      return;
    }

    awaitingReveal = true;
    activeGuess = '';
    setMsg('Not solved. Click any submitted cell to reveal a hint.');

    saveDayState();
    render();
    focusGame();
  }

  function onKeydown(e) {
    if (modalOpen) return;

    if (!e.ctrlKey && !e.metaKey && !e.altKey && (e.key === 'b' || e.key === 'B')) {
      e.preventDefault();
      toggleBalanceView();
      return;
    }

    if (done) return;
    if (awaitingReveal) return;

    if (e.key === 'Enter') {
      e.preventDefault();
      submitGuess();
      return;
    }

    if (e.key === 'Backspace') {
      e.preventDefault();
      backspace();
      return;
    }

    if (e.key === '(' || e.key === ')') {
      e.preventDefault();
      pushChar(e.key);
      return;
    }
  }

  function initUIFromState() {
    if (done && won) {
      setMatchPill(L);
    } else if (typeof matchValue === 'number') {
      setMatchPill(matchValue);
    } else if (rounds.length > 0) {
      const last = rounds[rounds.length - 1];
      const m = countMatches(last.gBal, ansBal);
      matchValue = m;
      setMatchPill(m);
    } else {
      setMatchPill(null);
    }

    if (done) {
      if (won) setMsg(`ÂÆåÊàêÔºöÁ¨¨ ${tries} Ê¨°Áåú‰∏≠„ÄÇ`, true);
      else setMsg(`Êú™ÂÆåÊàêÔºöÊ¨°Êï∞Â∑≤Áî®Â∞Ω„ÄÇÁ≠îÊ°à‰∏∫ ${answer}„ÄÇ`);
    } else if (awaitingReveal) {
      setMsg('Êú™ÂëΩ‰∏≠„ÄÇËØ∑ÁÇπÂáª‰ªªÊÑèÂ∑≤Êèê‰∫§Ê†ºÂ≠êÊè≠Á§∫ÊèêÁ§∫„ÄÇ');
    } else {
      setMsg('');
    }

    fitCellsToBoard();
    render();
  }

  // ‚úÖ resize / ÊóãËΩ¨ÔºöÈáçÊñ∞ËÆ°ÁÆó cellÔºàË¶ÜÁõñ‚Äú‰ªã‰∫éÁîµËÑëÂíåÊâãÊú∫‰πãÈó¥‚ÄùÁöÑÂå∫Èó¥Ôºâ
  let resizeRAF = null;
  window.addEventListener('resize', () => {
    if (resizeRAF) cancelAnimationFrame(resizeRAF);
    resizeRAF = requestAnimationFrame(() => {
      fitCellsToBoard();
      render();
    });
  });

  // Modal events
  $closeModal.addEventListener('click', () => closeModal());
  $modal.addEventListener('click', (e) => { if (e.target === $modal) closeModal(); });
  $modalCard.addEventListener('click', (e) => e.stopPropagation());

  $openStats.addEventListener('click', () => {
    renderStatsModal();
    openModal();
  });

  $shareBtn.addEventListener('click', async () => {
    if (!done) return;
    const text = makeShareText();
    const ok = await copyText(text);
    const old = $shareBtn.textContent;
    $shareBtn.disabled = true;
    $shareBtn.textContent = ok ? 'COPIED' : 'FAILED';
    setTimeout(() => {
      $shareBtn.textContent = old;
      $shareBtn.disabled = false;
      if (modalOpen) focusModal();
    }, 900);
  });

  // Game events
  window.addEventListener('keydown', onKeydown);
  $submit.addEventListener('click', () => { submitGuess(); focusGame(); });
  $toggleView.addEventListener('click', () => { toggleBalanceView(); });

  $keyL.addEventListener('click', () => pushChar('('));
  $keyR.addEventListener('click', () => pushChar(')'));
  $keyBk.addEventListener('click', () => backspace());

  $app.addEventListener('mousedown', () => focusGame());

  // Start
  startCountdown();

  requestAnimationFrame(() => {
    initUIFromState();
    if (done) {
      updateStatsIfNeeded();
      // ‚úÖ no jumpscare on refresh
      scheduleEndModal(won, true);
    }
  });
})();
</script>
</body>
</html>
